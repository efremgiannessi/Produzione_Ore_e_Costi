<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>STANDARD v2.8 â€” Ore & Costi + Advanced Dashboard</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0f1115; --panel:#151821; --muted:#1b2030; --text:#e6e6e6; --sub:#94a3b8; 
      --accent:#2dd4bf; /* Teal 400 */
      --accent-dim:rgba(45, 212, 191, 0.1);
      --line:#2a3042; 
      --danger:#f43f5e; --success:#10b981; --warning:#fbbf24;
      --chart-1:#818cf8; --chart-2:#f472b6; --chart-3:#34d399; --chart-4:#fbbf24;
      --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:13px/1.4 var(--font-main); overflow-x:hidden;}
    
    /* Layout */
    .wrap{
      max-width:1600px; margin:0 auto; padding:12px; display:flex; flex-direction:column; 
      min-height:100vh; box-sizing:border-box; gap:10px;
    }
    
    /* Toolbar */
    .toolbar{flex:0 0 auto; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;}
    .toolbar-group{display:flex; gap:6px; background:var(--panel); padding:6px; border:1px solid var(--line); border-radius:10px; flex-wrap:wrap;}
    
    /* Buttons */
    .btn{
      background:var(--muted); border:1px solid var(--line); color:var(--text); 
      padding:6px 12px; border-radius:6px; cursor:pointer; display:inline-flex; 
      gap:6px; align-items:center; font-size:12px; font-weight:500; transition:all 0.2s;
      white-space:nowrap;
    }
    .btn:hover{background:#262d40; border-color:#4b5563; color:#fff;}
    .btn:active{transform:translateY(1px);}
    .btn.primary{background:var(--accent); color:#0b0f15; border-color:transparent; font-weight:700;}
    .btn.primary:hover{opacity:0.9;}
    .btn.danger{color:var(--danger); border-color:rgba(244,63,94,0.3);}
    .btn.danger:hover{background:rgba(244,63,94,0.1);}

    /* KPI Cards */
    .cards{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; flex:0 0 auto;}
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:8px; 
      padding:10px 14px; display:flex; flex-direction:column; justify-content:center;
      transition: border-color 0.2s;
    }
    .card:hover{border-color:var(--sub);}
    .card h3{margin:0 0 4px 0; font-size:10px; text-transform:uppercase; letter-spacing:0.8px; color:var(--sub); font-weight:700;}
    .card .big{font-size:20px; font-weight:700; color:var(--text); letter-spacing:-0.5px;}
    .card .big.accent{color:var(--accent);}
    .card .big.warning{color:var(--warning);}
    
    /* Parameters Split */
    .split{display:grid; grid-template-columns:3fr 1fr; gap:8px; flex:0 0 auto;}
    .param-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px 12px;}
    .param-grid label{font-size:10px; color:var(--sub); display:block; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    /* Inputs */
    input, select{
      background:#0b0d12; color:var(--text); border:1px solid #2a3554; 
      border-radius:5px; padding:5px 8px; width:100%; box-sizing:border-box; 
      font-family:inherit; font-size:12px; transition: border 0.2s;
    }
    input:focus, select:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 2px var(--accent-dim);}
    .num{text-align:right;}
    .filters{display:flex; gap:6px; align-items:center;}
    
    /* Table Container */
    .grid-container{
      height: 500px; 
      min-height: 300px;
      flex: 0 0 auto;
      overflow:hidden; 
      border:1px solid var(--line); 
      border-radius:10px; 
      display:flex; 
      flex-direction:column; 
      background:var(--panel); 
      position:relative;
      resize: vertical; 
    }
    
    .grid-container::after {
      content: '';
      position: absolute;
      bottom: 2px; right: 2px;
      width: 10px; height: 10px;
      background: linear-gradient(135deg, transparent 50%, var(--sub) 50%);
      opacity: 0.5;
      pointer-events: none;
      z-index: 30;
    }

    .grid-scroll{overflow:auto; flex:1; scrollbar-width: thin; scrollbar-color: var(--line) var(--panel);}
    
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:1100px;}
    thead th{
      position:sticky; top:0; z-index:20; background:#1a1e29;
      border-bottom:1px solid var(--line); padding:8px; color:var(--sub);
      font-size:11px; text-align:left; font-weight:600; cursor:default;
      white-space:nowrap;
    }
    thead th.sortable:hover{color:var(--accent); cursor:pointer;}
    tbody tr{transition:background 0.1s;}
    tbody tr:hover{background:rgba(255,255,255,0.03);}
    tbody td{border-bottom:1px solid var(--line); padding:4px 6px; vertical-align:middle;}
    
    /* Input in table tweaks */
    td input {background:transparent; border:1px solid transparent; padding:4px;}
    td input:hover {border-color:#2a3554; background:#0b0d12;}
    td input:focus {background:#0b0d12; border-color:var(--accent);}
    
    /* Bars */
    .data-bar-cell{position:relative;}
    .data-bar{position:absolute; top:4px; bottom:4px; right:4px; background:var(--accent-dim); z-index:0; border-radius:3px; transition:width 0.4s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none;}
    .val-text{position:relative; z-index:1;}

    /* Footer */
    tfoot td{
      position:sticky; bottom:0; z-index:20; background:#1a1e29;
      border-top:1px solid var(--line); padding:8px; font-weight:700; color:var(--accent);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }

    /* Dashboard Standard */
    .dashboard{
      height:220px; flex:0 0 auto; display:grid; grid-template-columns:1fr 1fr 300px; gap:8px;
    }
    /* Dashboard Advanced */
    .dashboard-adv{
      height:240px; flex:0 0 auto; display:grid; grid-template-columns:1fr 1.5fr 1fr; gap:8px; margin-top:8px;
    }

    .dash-panel{
      background:var(--panel); border:1px solid var(--line); border-radius:8px; 
      padding:12px; display:flex; flex-direction:column; position:relative; overflow:hidden;
    }
    .dash-title{font-size:11px; font-weight:700; color:var(--sub); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; display:flex; justify-content:space-between; align-items:center;}
    
    /* Charts */
    .chart-container{flex:1; display:flex; align-items:center; justify-content:center; width:100%; overflow:hidden;}
    .legend{font-size:10px; margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; color:var(--sub);}
    .dot{width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px;}
    
    /* Bars Chart */
    .bar-row{display:flex; align-items:center; gap:8px; margin-bottom:5px; font-size:11px; width:100%; cursor:pointer;}
    .bar-row:hover .bar-label{color:var(--accent);}
    .bar-label{width:90px; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8; transition:color 0.2s;}
    .bar-track{flex:1; background:#1f2430; height:8px; border-radius:4px; overflow:hidden;}
    .bar-fill{height:100%; background:var(--accent); transition:width 0.6s cubic-bezier(0,0,0.2,1);}
    .bar-val{width:50px; text-align:right; font-weight:600; font-size:10px; color:var(--text);}

    /* Top List */
    .top-item{display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid var(--line); font-size:11px;}
    .top-item:last-child{border:none;}
    .top-item span{color:var(--sub);}
    
    /* Scatter Plot Dots */
    .scatter-dot{transition: all 0.2s;}
    .scatter-dot:hover{r: 6px; stroke: #fff; stroke-width: 2px; opacity: 1;}

    /* Stacked Bars */
    .stack-bar:hover {opacity:0.8; cursor:pointer;}

    /* Utilities */
    .badge{font-size:9px; color:#0b0f15; background:var(--accent); padding:2px 6px; border-radius:4px; font-weight:700; margin-left:8px; vertical-align:middle; text-transform:uppercase;}
    .note{color:var(--sub); font-size:11px;}

    /* RESPONSIVE */
    @media (max-width: 1000px) {
       .dashboard, .dashboard-adv { height: auto; grid-template-columns: 1fr 1fr; }
       .dash-panel:nth-child(3) { grid-column: span 2; }
       .split { grid-template-columns: 1fr; }
       .wrap { height: auto; overflow: auto; display:block;}
       .grid-container { min-height: 400px; }
    }
    @media (max-width: 600px) {
       .cards { grid-template-columns: 1fr 1fr; }
       .param-grid { grid-template-columns: 1fr 1fr; }
       .dashboard, .dashboard-adv { grid-template-columns: 1fr; }
       .dash-panel:nth-child(3) { grid-column: auto; }
       .filters { flex-wrap: wrap; width: 100%; }
       .filters input, .filters select { width: 100%; }
    }

    /* Print Fix - Correzione Taglio Tabella */
    @media print{
      @page{size:A4 landscape; margin:5mm;}
      body{background:#fff; color:#000; -webkit-print-color-adjust:exact;}
      .toolbar, .filters, .note-download{display:none !important;}
      .wrap{height:auto; overflow:visible; display:block; padding:0;}
      
      /* FIX CRUCIALE PER TABELLA SCORREVOLE */
      .grid-container{
        border:none; 
        overflow:visible !important; 
        height: auto !important; /* Rimuove il limite 500px */
        display: block !important;
        background:none;
        min-height: auto !important;
      }
      .grid-scroll { overflow: visible !important; }
      
      table{border:1px solid #ccc; font-size:9px; color:#000; width:100%;}
      thead th{background:#eee; color:#000; border-bottom:1px solid #000; position:static;}
      tfoot td{background:#eee; color:#000; position:static; border-top:2px solid #000;}
      tbody td{border-bottom:1px solid #ccc;}
      
      input{border:none; background:transparent; color:#000; padding:0; text-align:right;}
      input.inp-ruolo, input.inp-note, input.inp-centro {text-align:left;}
      
      /* Layout Dashboard Stampa */
      .card, .dash-panel{border:1px solid #000; break-inside:avoid; page-break-inside:avoid; background:#fff; color:#000;}
      .data-bar{display:none;} 
      .dashboard, .dashboard-adv{height:auto; grid-template-columns:1fr 1fr 1fr; margin-top:20px; gap:20px; display:grid !important;}
      .chart-container svg text{fill:#000 !important;}
      .btn{display:none;}
    }
  </style>
</head>
<body>

<div class="wrap">
  
  <!-- Header -->
  <div style="flex:0 0 auto">
    <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:10px;">
        <h2 style="margin:0; display:flex; align-items:center; font-size:18px;">
        STANDARD v2.8 <span style="font-weight:400; color:var(--sub); margin:0 8px; font-size:14px;">â€” Analisi & Budget</span>
        <span class="badge">BETA</span>
        </h2>
    </div>
    
    <div class="toolbar">
      <div class="toolbar-group">
        <button class="btn primary" id="addRow"><span>+</span> Riga</button>
        <button class="btn" id="dupRow">Duplica</button>
        <button class="btn danger" id="delRow">Elimina</button>
      </div>
      
      <div class="toolbar-group">
        <div class="filters">
          <input id="search" placeholder="ðŸ” Filtra..." style="min-width:140px"/>
          <select id="fTipo" style="width:auto"><option value="">Tutti</option><option>Interno</option><option>Esterno</option></select>
          <select id="fCentro" style="width:auto"><option value="">Centri</option></select>
        </div>
      </div>

      <div class="toolbar-group">
        <button class="btn" id="restoreDefaults" title="Ripristina Dati Esempio">Reset</button>
        <button class="btn" id="exportCSV">.CSV</button>
        <button class="btn" id="print">PDF</button>
        <button class="btn" id="save">Salva</button>
        <button class="btn" id="load">Carica</button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <section class="cards" id="summaryCards">
    <div class="card">
        <h3>Costo Diretto</h3>
        <div class="big" id="costoDirettoTot">â‚¬ 0</div>
        <div class="note" id="oreDiretteTot">0 h</div>
    </div>
    <div class="card">
        <h3>Costo Industriale</h3>
        <div class="big" id="costoIndustriale">â‚¬ 0</div>
        <div class="note">Dir + Ind + Forf + OH</div>
    </div>
    <div class="card">
        <h3>Costo Pieno</h3>
        <div class="big warning" id="costoPieno">â‚¬ 0</div>
        <div class="note">+ Imprevisti + Fissi</div>
    </div>
    <div class="card" style="border-color:var(--accent)">
        <h3>PREZZO OFFERTA</h3>
        <div class="big accent" id="prezzoFinale">â‚¬ 0</div>
        <div class="note">+ Margine %</div>
    </div>
  </section>

  <!-- Parameters -->
  <section class="split">
    <div class="card">
      <h3>Parametri Economici Generali</h3>
      <div class="param-grid">
        <div><label title="Percentuale calcolata sui costi diretti">Overhead % (su Dir.)</label><input type="text" class="num" id="overheadPct" value="15,00"></div>
        <div><label title="Moltiplicatore globale del costo orario">Coeff. Straordinari</label><input type="text" class="num" id="coeffGlobale" value="1,00"></div>
        <div><label title="Percentuale di sicurezza sul costo totale">Imprevisti % (Rischio)</label><input type="text" class="num" id="imprevistiPct" value="2,00"></div>
        <div><label title="Percentuale di ricarico sul costo pieno">Margine % (Utile)</label><input type="text" class="num" id="marginePct" value="12,00"></div>
        
        <div><label title="Costi fissi extra commessa">Costi Fissi Extra (â‚¬)</label><input type="text" class="num" id="costiFissi" value="500"></div>
        <div><label>Totale Pezzi (opz.)</label><input type="text" class="num" id="pezzi" placeholder="0"></div>
        <div><label>Totale mÂ³ (opz.)</label><input type="text" class="num" id="volume" placeholder="0,00"></div>
        <div></div> 
      </div>
    </div>
    <div class="card">
      <h3>Unitari</h3>
      <div style="display:flex; flex-direction:column; justify-content:center; height:100%; gap:8px">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); padding-bottom:4px">
            <span class="note">Prezzo / Pezzo</span>
            <span class="big" style="font-size:15px; color:var(--text)" id="costoPerPezzo">â‚¬ -</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="note">Prezzo / mÂ³</span>
            <span class="big" style="font-size:15px; color:var(--text)" id="costoPerMc">â‚¬ -</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Grid -->
  <div class="grid-container">
    <div class="grid-scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:30px; text-align:center"><input type="checkbox" id="selAll"></th>
            <th style="width:90px">Tipo</th>
            <th style="width:130px">Centro Costo</th>
            <th style="min-width:180px">Ruolo / Voce Spesa</th>
            <th class="num" style="width:60px">Ore D.</th>
            <th class="num" style="width:60px">â‚¬/h</th>
            <th class="num" style="width:50px">K</th>
            <th class="num sortable" onclick="app.sortBy('cd')" style="width:90px">Tot Dir â–¼</th>
            <th class="num" style="width:60px">Ore I.</th>
            <th class="num" style="width:60px">â‚¬/h I.</th>
            <th class="num" style="width:50px">K</th>
            <th class="num sortable" onclick="app.sortBy('ci')" style="width:90px">Tot Ind â–¼</th>
            <th class="num" style="width:80px">Forfait</th>
            <th style="min-width:150px">Note</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
        <tfoot>
          <tr>
            <td colspan="4">Totali Vista</td>
            <td class="num" id="ftOreD">0</td>
            <td></td><td></td>
            <td class="num" id="ftCostD">â‚¬ 0</td>
            <td class="num" id="ftOreI">0</td>
            <td></td><td></td>
            <td class="num" id="ftCostI">â‚¬ 0</td>
            <td class="num" id="ftForfait">â‚¬ 0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- DASHBOARD STANDARD -->
  <section class="dashboard">
    <!-- Grafico 1: Composizione Prezzo -->
    <div class="dash-panel">
        <div class="dash-title">Composizione Prezzo Finale</div>
        <div class="chart-container" id="chartDonut"></div>
        <div class="legend">
            <div><span class="dot" style="background:var(--chart-1)"></span>Diretti</div>
            <div><span class="dot" style="background:var(--chart-2)"></span>Indiretti</div>
            <div><span class="dot" style="background:var(--chart-3)"></span>Spese Gen.</div>
            <div><span class="dot" style="background:var(--chart-4)"></span>Utile</div>
        </div>
    </div>

    <!-- Grafico 2: Costi per Centro -->
    <div class="dash-panel">
        <div class="dash-title">Top Incidenza Centri (Costo)</div>
        <div class="chart-container" style="display:block; overflow-y:auto; padding-right:4px;" id="chartBars"></div>
    </div>

    <!-- Statistiche -->
    <div class="dash-panel">
        <div class="dash-title">Top 3 Costi</div>
        <div id="topList" style="flex:1; margin-bottom:12px; overflow-y:auto;"></div>
        
        <div class="dash-title" style="margin-top:auto; border-top:1px solid var(--line); padding-top:8px">Efficienza</div>
        <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="note">Rapporto Ind/Dir</span>
            <span class="big" id="ratioEff">0%</span>
        </div>
    </div>
  </section>

  <!-- DASHBOARD AVANZATA (NEW) -->
  <section class="dashboard-adv">
    <!-- Grafico 3: Efficienza Ore Centri -->
    <div class="dash-panel">
        <div class="dash-title">
            Efficienza Operativa (Ore)
            <span class="badge" style="background:var(--muted); color:var(--sub)">INTERATTIVO</span>
        </div>
        <div class="chart-container" style="display:block; overflow-y:auto; padding-right:4px;" id="chartStack"></div>
        <div class="legend">
            <div><span class="dot" style="background:var(--accent)"></span>Ore Dir</div>
            <div><span class="dot" style="background:#f472b6"></span>Ore Ind</div>
        </div>
    </div>

    <!-- Grafico 4: Scatter Plot (Mappa Costi) -->
    <div class="dash-panel">
        <div class="dash-title">
            Mappa Costi (Dispersione)
            <span class="note" style="font-weight:400; font-size:9px">Dimensione = Costo Totale</span>
        </div>
        <div class="chart-container" id="chartScatter"></div>
    </div>

    <!-- Grafico 5: Interno vs Esterno -->
    <div class="dash-panel">
        <div class="dash-title">Mix Risorse</div>
        <div class="chart-container" id="chartMix"></div>
        <div class="legend">
            <div><span class="dot" style="background:#34d399"></span>Interno</div>
            <div><span class="dot" style="background:#fbbf24"></span>Esterno</div>
        </div>
    </div>
  </section>

  <datalist id="centriList"></datalist>
  <datalist id="vociList"></datalist>
</div>

<script>
const app = (function(){
  const fmtEur = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR', maximumFractionDigits:0});
  const fmtDec = new Intl.NumberFormat('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2});
  
  const parseNum = v => {
    if(v === null || v === undefined || v === '') return 0;
    if(typeof v === 'number') return v;
    let s = v.toString();
    s = s.replace(/\./g,'').replace(',','.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  };

  const qs = s => document.querySelector(s);
  const qsa = s => document.querySelectorAll(s);

  const CENTRI_DEF = ['Direzione','Reparto','Ferro','Magazzino','Ufficio Tecnico','QualitÃ ','Manutenzione','Logistica','Sicurezza','Servizi','Amministrazione','Commerciale'];
  
  // LISTA COMPLETA
  const DEFAULT_ROWS = [
    {sel:false,tipo:'Interno',centro:'Direzione',ruolo:'Direttore Stabilimento', oreDir:0, costoOrario:45, coeffDir:1, oreInd:2, costoInd:45, coeffInd:1, forfait:0, note:'supervisione'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Capo reparto', oreDir:0, costoOrario:28, coeffDir:1, oreInd:6, costoInd:28, coeffInd:1, forfait:0, note:'coordinamento'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Carpentieri casseri', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Operaio getto', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Finitura / vibrazione', oreDir:0, costoOrario:21, coeffDir:1, oreInd:0, costoInd:21, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Pulizia casseri', oreDir:0, costoOrario:20, coeffDir:1, oreInd:0, costoInd:20, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ferro',ruolo:'Armatori (gabbie)', oreDir:0, costoOrario:25, coeffDir:1, oreInd:0, costoInd:25, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ferro',ruolo:'Taglio e piega', oreDir:0, costoOrario:24, coeffDir:1, oreInd:0, costoInd:24, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Magazzino',ruolo:'Carrellisti', oreDir:10, costoOrario:20, coeffDir:1, oreInd:0, costoInd:20, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Logistica',ruolo:'Pianificazione carichi', oreDir:0, costoOrario:21, coeffDir:1, oreInd:2, costoInd:21, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Manutenzione',ruolo:'Meccanici/impiantisti', oreDir:0, costoOrario:23, coeffDir:1, oreInd:2, costoInd:23, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'QualitÃ ',ruolo:'Collaudi e controlli', oreDir:0, costoOrario:24, coeffDir:1, oreInd:3, costoInd:24, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Sicurezza',ruolo:'Preposto / RSPP', oreDir:0, costoOrario:22, coeffDir:1, oreInd:2, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'Disegnatori', oreDir:0, costoOrario:28, coeffDir:1, oreInd:6, costoInd:28, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'Tecnico di produzione', oreDir:0, costoOrario:29, coeffDir:1, oreInd:4, costoInd:29, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Amministrazione',ruolo:'Segreteria', oreDir:0, costoOrario:26, coeffDir:1, oreInd:3, costoInd:26, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Commerciale',ruolo:'Preventivista / PM', oreDir:0, costoOrario:27, coeffDir:1, oreInd:2, costoInd:27, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Verniciatori / Sabbiatori', oreDir:0, costoOrario:24, coeffDir:1, oreInd:1, costoInd:24, coeffInd:1, forfait:0, note:'trattamenti sup.'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Saldatore Patentato', oreDir:0, costoOrario:26, coeffDir:1, oreInd:0, costoInd:26, coeffInd:1, forfait:0, note:'specializzato'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Imballaggio finale', oreDir:0, costoOrario:20, coeffDir:1, oreInd:0, costoInd:20, coeffInd:1, forfait:0, note:'preparazione carico'},
    {sel:false,tipo:'Esterno',centro:'Ufficio Tecnico',ruolo:'Consulenza Strutturale', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'relazione calcolo'},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'R&D / Prototipazione', oreDir:0, costoOrario:30, coeffDir:1, oreInd:0, costoInd:30, coeffInd:1, forfait:0, note:'studio nuovi nodi'},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'As-Built / Doc. Finale', oreDir:0, costoOrario:28, coeffDir:1, oreInd:0, costoInd:28, coeffInd:1, forfait:0, note:'aggiornamento disegni'},
    {sel:false,tipo:'Esterno',centro:'Logistica',ruolo:'Scorta Tecnica', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'trasporti eccezionali'},
    {sel:false,tipo:'Interno',centro:'Logistica',ruolo:'Gruista (Dedicato)', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:'movimentazione'},
    {sel:false,tipo:'Interno',centro:'Commerciale',ruolo:'Sopralluoghi Cantiere', oreDir:0, costoOrario:35, coeffDir:1, oreInd:0, costoInd:35, coeffInd:1, forfait:0, note:'viaggi e rilievi'},
    {sel:false,tipo:'Interno',centro:'QualitÃ ',ruolo:'Formazione Specifica', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:25, coeffInd:1, forfait:0, note:'ingresso cantiere'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Rilavorazioni / Non Conf.', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:'buffer errori'},
    {sel:false,tipo:'Interno',centro:'Manutenzione',ruolo:'Manutenzione Stampi', oreDir:0, costoOrario:23, coeffDir:1, oreInd:0, costoInd:23, coeffInd:1, forfait:0, note:'ripristino casseri'},
    {sel:false,tipo:'Esterno',centro:'QualitÃ ',ruolo:'Laboratorio Prove Mat.', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'cubetti/trazione'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Nolo autogru', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:800, note:'tariffa/giorno'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Trasporto (Bilico)', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/viaggio'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Trasporto (Carro attrez.)', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/viaggio'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Piattaforma aerea', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/giorno'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Subappalto casseri', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Smaltimento Rifiuti', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/mese'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Pulizie Industriali', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'impresa est.'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Stoccaggio esterno', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/mese'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Nolo Bagni/Baracche', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'allestimento cantiere'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Vigilanza / Guardiania', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'sicurezza notturna'}
  ];

  let state = {
    rows: JSON.parse(JSON.stringify(DEFAULT_ROWS)),
    overheadPct: 15,
    imprevistiPct: 2,
    marginePct: 12,
    costiFissi: 500,
    pezzi: 0,
    volume: 0,
    coeffGlobale: 1,
    filter: { q:'', tipo:'', centro:'' }
  };

  function init(){
    loadLS();
    bindEvents();
    renderStructure(); 
    updateCalculations();
  }

  function saveLS(){ localStorage.setItem('OreCosti_v2', JSON.stringify(state)); }
  function loadLS(){ const d = localStorage.getItem('OreCosti_v2'); if(d) { try{ Object.assign(state, JSON.parse(d)); }catch(e){} } }

  function renderStructure(){
    const tbody = qs('#body');
    const filtered = getFilteredRows();
    
    if(filtered.length === 0){
      tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:30px;color:var(--sub)">Nessuna voce trovata.<br><br><button class="btn primary" onclick="app.addRow()">+ Aggiungi riga</button></td></tr>';
      updateFiltersUI();
      return;
    }

    const html = filtered.map(({r, idx}) => {
      const isExt = r.tipo==='Esterno';
      let rowClass = r.sel ? 'background:rgba(45,212,191,0.05)' : '';
      let typeColor = isExt ? 'color:#fbbf24' : 'color:#34d399';
      
      return `<tr data-idx="${idx}" style="${rowClass}">
        <td style="text-align:center"><input type="checkbox" class="row-sel" ${r.sel?'checked':''}></td>
        <td><select class="inp-tipo" style="${typeColor}"><option ${r.tipo==='Interno'?'selected':''}>Interno</option><option ${r.tipo==='Esterno'?'selected':''}>Esterno</option></select></td>
        <td><input type="text" list="centriList" class="inp-centro" value="${esc(r.centro)}"></td>
        <td><input type="text" list="vociList" class="inp-ruolo" value="${esc(r.ruolo)}" style="font-weight:600"></td>
        <td><input type="text" class="num inp-calc inp-oreD" value="${fmtNum(r.oreDir)}"></td>
        <td><input type="text" class="num inp-calc inp-costoH" value="${fmtNum(r.costoOrario)}"></td>
        <td><input type="text" class="num inp-calc inp-cDir" value="${fmtNum(r.coeffDir)}"></td>
        <td class="num data-bar-cell"><div class="data-bar bar-cd" style="width:0%"></div><span class="val-cd val-text">â‚¬ 0</span></td>
        <td><input type="text" class="num inp-calc inp-oreI" value="${fmtNum(r.oreInd)}"></td>
        <td><input type="text" class="num inp-calc inp-costoHi" value="${fmtNum(r.costoInd)}"></td>
        <td><input type="text" class="num inp-calc inp-cInd" value="${fmtNum(r.coeffInd)}"></td>
        <td class="num data-bar-cell"><div class="data-bar bar-ci" style="width:0%; background:rgba(236,72,153,0.15)"></div><span class="val-ci val-text">â‚¬ 0</span></td>
        <td><input type="text" class="num inp-calc inp-forf" value="${fmtNum(r.forfait)}"></td>
        <td><input type="text" class="inp-note" value="${esc(r.note)}" style="color:var(--sub)"></td>
      </tr>`;
    }).join('');
    
    tbody.innerHTML = html;
    updateFiltersUI();
  }

  function updateCalculations(){
    state.overheadPct = parseNum(qs('#overheadPct').value);
    state.imprevistiPct = parseNum(qs('#imprevistiPct').value);
    state.marginePct = parseNum(qs('#marginePct').value);
    state.costiFissi = parseNum(qs('#costiFissi').value);
    state.coeffGlobale = parseNum(qs('#coeffGlobale').value) || 1;
    state.pezzi = parseNum(qs('#pezzi').value);
    state.volume = parseNum(qs('#volume').value);

    let totOreD=0, totOreI=0, totCostD=0, totCostI=0, totForf=0;
    let totInt=0, totExt=0;
    let maxCostRow = 1;
    let centriStats = {};
    let centriHours = {}; // { Center: {dir: X, ind: Y} }
    let rowCosts = []; 
    let scatterData = [];

    const rows = Array.from(qs('#body').rows);
    
    // Calculation Pass
    rows.forEach(tr => {
      if(!tr.dataset.idx) return;
      const i = +tr.dataset.idx;
      const r = state.rows[i];
      const glob = state.coeffGlobale;

      const cd = r.oreDir * r.costoOrario * (r.coeffDir||1) * glob;
      const ci = r.oreInd * r.costoInd * (r.coeffInd||1) * glob;
      const rf = (r.tipo==='Esterno') ? r.forfait : 0;
      const totRow = cd + ci + rf;

      // Data aggregation for charts
      if(r.centro && totRow > 0){
        centriStats[r.centro] = (centriStats[r.centro] || 0) + totRow;
        
        if(!centriHours[r.centro]) centriHours[r.centro] = {dir:0, ind:0};
        centriHours[r.centro].dir += r.oreDir;
        centriHours[r.centro].ind += r.oreInd;
      }

      if(r.tipo === 'Interno') totInt += totRow;
      else totExt += totRow;

      if(totRow > 0) {
        rowCosts.push({role: r.ruolo, val: totRow});
        // Scatter data: x = hourly cost (avg), y = total hours, z = total cost
        const avgRate = (r.oreDir + r.oreInd) > 0 ? (cd+ci)/(r.oreDir+r.oreInd) : 0;
        const totHours = r.oreDir + r.oreInd;
        if(avgRate > 0 || totRow > 0) {
            scatterData.push({x: avgRate > 0 ? avgRate : totRow/10, y: totHours > 0 ? totHours : 1, val: totRow, label: r.ruolo});
        }
      }

      tr.querySelector('.val-cd').textContent = fmtEur.format(cd);
      tr.querySelector('.val-ci').textContent = fmtEur.format(ci);
      
      totOreD += r.oreDir;
      totOreI += r.oreInd;
      totCostD += cd;
      totCostI += ci;
      totForf += rf;
      
      maxCostRow = Math.max(maxCostRow, cd, ci);
    });

    // Bars Visual Pass
    rows.forEach(tr => {
        if(!tr.dataset.idx) return;
        const i = +tr.dataset.idx;
        const r = state.rows[i];
        const glob = state.coeffGlobale;
        const cd = r.oreDir * r.costoOrario * (r.coeffDir||1) * glob;
        const ci = r.oreInd * r.costoInd * (r.coeffInd||1) * glob;
        tr.querySelector('.bar-cd').style.width = Math.min(100, (cd/maxCostRow*100))+'%';
        tr.querySelector('.bar-ci').style.width = Math.min(100, (ci/maxCostRow*100))+'%';
    });

    // Totals Calculation
    const overheadVal = totCostD * (state.overheadPct/100);
    const costoIndustriale = totCostD + totCostI + totForf + overheadVal;
    const imprevistiVal = costoIndustriale * (state.imprevistiPct/100);
    const speseGenFisse = state.costiFissi; 
    const costoPieno = costoIndustriale + imprevistiVal + speseGenFisse;
    const margineVal = costoPieno * (state.marginePct/100);
    const prezzoFinale = costoPieno + margineVal;

    // DOM Updates
    qs('#oreDiretteTot').textContent = fmtDec.format(totOreD) + ' h';
    qs('#costoDirettoTot').textContent = fmtEur.format(totCostD);
    qs('#costoIndustriale').textContent = fmtEur.format(costoIndustriale);
    qs('#costoPieno').textContent = fmtEur.format(costoPieno);
    qs('#prezzoFinale').textContent = fmtEur.format(prezzoFinale);
    const pp = state.pezzi > 0 ? prezzoFinale/state.pezzi : 0;
    const pm = state.volume > 0 ? prezzoFinale/state.volume : 0;
    qs('#costoPerPezzo').textContent = state.pezzi > 0 ? fmtEur.format(pp) : 'â‚¬ -';
    qs('#costoPerMc').textContent = state.volume > 0 ? fmtEur.format(pm) : 'â‚¬ -';
    qs('#ftOreD').textContent = fmtDec.format(totOreD);
    qs('#ftCostD').textContent = fmtEur.format(totCostD);
    qs('#ftOreI').textContent = fmtDec.format(totOreI);
    qs('#ftCostI').textContent = fmtEur.format(totCostI);
    qs('#ftForfait').textContent = fmtEur.format(totForf);

    // --- STANDARD DASHBOARD ---
    drawDonut([totCostD, totCostI + totForf, overheadVal + imprevistiVal + speseGenFisse, margineVal], prezzoFinale);
    drawBars(centriStats);
    rowCosts.sort((a,b) => b.val - a.val);
    qs('#topList').innerHTML = rowCosts.slice(0,3).map(i => `<div class="top-item"><span>${esc(i.role)}</span><b>${fmtEur.format(i.val)}</b></div>`).join('') || '<div class="note" style="text-align:center">Nessun dato</div>';
    const ratio = totOreD > 0 ? (totOreI / totOreD) * 100 : 0;
    const elRatio = qs('#ratioEff');
    elRatio.textContent = ratio.toFixed(1) + '%';
    elRatio.style.color = ratio > 40 ? 'var(--danger)' : (ratio > 25 ? 'var(--warning)' : 'var(--success)');

    // --- ADVANCED DASHBOARD ---
    drawStackedBars(centriHours);
    drawScatter(scatterData);
    drawMix(totInt, totExt);
  }

  // --- DRAWING FUNCTIONS ---

  function drawDonut(values, total){
     const colors = ['var(--chart-1)', 'var(--chart-2)', 'var(--chart-3)', 'var(--chart-4)']; 
     if(total <= 0) { qs('#chartDonut').innerHTML = '<div class="note">Nessun dato</div>'; return; }
     let acc = 0; const r = 15.9155; const strokeW = 8;
     const svgContent = values.map((v, i) => {
         const pct = (v / total) * 100;
         const dash = `${Math.max(0, pct - 0.5)} ${100 - Math.max(0, pct - 0.5)}`;
         const segment = `<circle cx="21" cy="21" r="${r}" fill="transparent" stroke="${colors[i]}" stroke-width="${strokeW}" stroke-dasharray="${dash}" stroke-dashoffset="${25 - acc}"></circle>`;
         acc += pct;
         return segment;
     }).join('');
     qs('#chartDonut').innerHTML = `<svg width="100%" height="100%" viewBox="0 0 42 42">${svgContent}<text x="21" y="22" fill="var(--text)" font-size="5px" font-weight="bold" text-anchor="middle">100%</text></svg>`;
  }

  function drawBars(dataMap){
     const container = qs('#chartBars');
     const entries = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]).slice(0, 6);
     if(entries.length === 0) { container.innerHTML = '<div class="note">Nessun dato</div>'; return; }
     const maxVal = entries[0][1] || 1;
     container.innerHTML = entries.map(([label, val]) => {
         const pct = (val / maxVal) * 100;
         return `<div class="bar-row" onclick="app.filterC('${esc(label)}')">
           <div class="bar-label" title="${esc(label)}">${esc(label)}</div>
           <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
           <div class="bar-val">${fmtEur.format(val)}</div>
         </div>`;
     }).join('');
  }

  function drawStackedBars(dataMap){
      const container = qs('#chartStack');
      const entries = Object.entries(dataMap).sort((a,b)=>(b[1].dir+b[1].ind)-(a[1].dir+a[1].ind)).slice(0, 6);
      if(entries.length === 0) { container.innerHTML = '<div class="note">Nessun dato</div>'; return; }
      
      // Find max total hours for scaling
      const maxH = Math.max(...entries.map(e => e[1].dir + e[1].ind)) || 1;

      container.innerHTML = entries.map(([label, v]) => {
          const pDir = (v.dir / maxH) * 100;
          const pInd = (v.ind / maxH) * 100;
          return `<div class="bar-row stack-bar" onclick="app.filterC('${esc(label)}')">
            <div class="bar-label" title="${esc(label)}">${esc(label)}</div>
            <div class="bar-track" style="display:flex; background:#1f2430">
                <div style="width:${pDir}%; background:var(--accent); height:100%" title="Dir: ${fmtDec.format(v.dir)}h"></div>
                <div style="width:${pInd}%; background:#f472b6; height:100%" title="Ind: ${fmtDec.format(v.ind)}h"></div>
            </div>
            <div class="bar-val">${Math.round(v.dir+v.ind)}h</div>
          </div>`;
      }).join('');
  }

  function drawScatter(data){
      if(!data.length) { qs('#chartScatter').innerHTML = '<div class="note">Nessun dato</div>'; return; }
      // Normalize
      const maxX = Math.max(...data.map(d=>d.x)) * 1.1 || 100;
      const maxY = Math.max(...data.map(d=>d.y)) * 1.1 || 100;
      const maxR = Math.max(...data.map(d=>d.val)) || 1;
      
      const circles = data.map(d => {
          const cx = (d.x / maxX) * 100;
          const cy = 100 - ((d.y / maxY) * 100);
          const r = Math.max(2, (d.val / maxR) * 10); // scale radius by cost impact
          const col = d.val > (maxR*0.7) ? 'var(--danger)' : 'var(--accent)';
          return `<circle cx="${cx}%" cy="${cy}%" r="${r}" fill="${col}" opacity="0.6" class="scatter-dot">
            <title>${d.label}: â‚¬${Math.round(d.x)}/h, ${d.y}h (Tot: â‚¬${Math.round(d.val)})</title>
          </circle>`;
      }).join('');

      // Add Axes Lines
      const axis = `<line x1="5%" y1="95%" x2="95%" y2="95%" stroke="var(--line)" stroke-width="1"/><line x1="5%" y1="5%" x2="5%" y2="95%" stroke="var(--line)" stroke-width="1"/>`;
      // Labels
      const txt = `<text x="95%" y="98%" fill="var(--sub)" font-size="6" text-anchor="end">â‚¬/h</text><text x="5%" y="5%" fill="var(--sub)" font-size="6" text-anchor="start">Ore</text>`;

      qs('#chartScatter').innerHTML = `<svg width="100%" height="100%">${axis}${circles}${txt}</svg>`;
  }

  function drawMix(v1, v2){
      const tot = v1+v2;
      if(tot<=0) { qs('#chartMix').innerHTML = ''; return; }
      const p1 = (v1/tot)*100;
      const p2 = (v2/tot)*100;
      
      const bar = `
        <div style="display:flex; height:20px; width:100%; border-radius:4px; overflow:hidden; margin-top:20px;">
            <div style="width:${p1}%; background:#34d399; display:flex; align-items:center; justify-content:center; font-size:10px; color:#000; font-weight:700">${Math.round(p1)}%</div>
            <div style="width:${p2}%; background:#fbbf24; display:flex; align-items:center; justify-content:center; font-size:10px; color:#000; font-weight:700">${Math.round(p2)}%</div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px; color:var(--text)">
            <div>${fmtEur.format(v1)}</div>
            <div>${fmtEur.format(v2)}</div>
        </div>
      `;
      qs('#chartMix').innerHTML = bar;
  }

  function filterC(name){
      qs('#fCentro').value = name;
      // Trigger event
      qs('#fCentro').dispatchEvent(new Event('input'));
  }

  function bindEvents(){
    qsa('.split input').forEach(el => el.addEventListener('input', ()=>{ updateCalculations(); saveLS(); }));
    const body = qs('#body');
    body.addEventListener('input', e => {
      const el = e.target;
      const tr = el.closest('tr');
      if(!tr) return;
      const i = +tr.dataset.idx;
      const r = state.rows[i];
      if(el.classList.contains('inp-calc')) {
        if(el.classList.contains('inp-oreD')) r.oreDir = parseNum(el.value);
        if(el.classList.contains('inp-costoH')) r.costoOrario = parseNum(el.value);
        if(el.classList.contains('inp-cDir')) r.coeffDir = parseNum(el.value);
        if(el.classList.contains('inp-oreI')) r.oreInd = parseNum(el.value);
        if(el.classList.contains('inp-costoHi')) r.costoInd = parseNum(el.value);
        if(el.classList.contains('inp-cInd')) r.coeffInd = parseNum(el.value);
        if(el.classList.contains('inp-forf')) r.forfait = parseNum(el.value);
        updateCalculations(); 
      } else if(el.classList.contains('inp-tipo')){ r.tipo = el.value; renderStructure(); 
      } else if(el.classList.contains('inp-centro')){ r.centro = el.value; updateFiltersUI(); 
      } else if(el.classList.contains('inp-ruolo')){ r.ruolo = el.value;
      } else if(el.classList.contains('inp-note')){ r.note = el.value;
      } else if(el.classList.contains('row-sel')){ r.sel = el.checked; renderStructure(); }
      saveLS();
    });
    
    // Bind Buttons
    qs('#addRow').onclick = () => { 
        state.rows.push({sel:false,tipo:'Interno',centro:'',ruolo:'',oreDir:0,costoOrario:0,coeffDir:1,oreInd:0,costoInd:0,coeffInd:1,forfait:0,note:''}); 
        state.filter.q = ''; qs('#search').value = '';
        renderStructure(); updateCalculations(); saveLS(); 
        setTimeout(()=> qs('.grid-scroll').scrollTop = qs('.grid-scroll').scrollHeight, 50);
    };
    qs('#dupRow').onclick = () => { 
        const dups = state.rows.filter(r=>r.sel).map(r=>({...r, sel:false})); 
        if(dups.length){ state.rows.push(...dups); renderStructure(); updateCalculations(); saveLS(); } 
        else { alert("Seleziona una riga per duplicarla"); }
    };
    qs('#delRow').onclick = () => { 
        if(!state.rows.some(r=>r.sel)) return alert("Seleziona righe da eliminare");
        if(!confirm('Eliminare righe selezionate?')) return; 
        state.rows = state.rows.filter(r=>!r.sel); renderStructure(); updateCalculations(); saveLS(); 
    };
    qs('#restoreDefaults').onclick = () => { if(confirm('Ricaricare i dati di esempio? Le modifiche attuali andranno perse.')) { state.rows = JSON.parse(JSON.stringify(DEFAULT_ROWS)); renderStructure(); updateCalculations(); saveLS(); }};
    qs('#selAll').onchange = (e) => { state.rows.forEach(r => r.sel = e.target.checked); renderStructure(); };
    
    // Bind Filters
    ['search','fTipo','fCentro'].forEach(id => { 
        qs('#'+id).addEventListener('input', e => { 
            state.filter.q = qs('#search').value.toLowerCase(); 
            state.filter.tipo = qs('#fTipo').value; 
            state.filter.centro = qs('#fCentro').value; 
            renderStructure(); 
            updateCalculations();
        }); 
    });
    
    qs('#print').onclick = () => window.print();
    qs('#exportCSV').onclick = exportCSV;
    qs('#save').onclick = () => downloadJSON(state, 'AnalisiCosti_v2.json');
    qs('#load').onclick = loadJSON;
  }

  function getFilteredRows(){
    const f = state.filter;
    return state.rows.map((r,idx)=>({r,idx})).filter(({r}) => {
        if(f.tipo && r.tipo !== f.tipo) return false;
        if(f.centro && r.centro !== f.centro) return false;
        if(f.q && !((r.ruolo||'').toLowerCase().includes(f.q) || (r.note||'').toLowerCase().includes(f.q) || (r.centro||'').toLowerCase().includes(f.q))) return false;
        return true;
    });
  }

  function updateFiltersUI(){
    const centri = unique(state.rows.map(r=>r.centro));
    const ruoli = unique(state.rows.map(r=>r.ruolo));
    if(document.activeElement !== qs('#fCentro')) fillSelect(qs('#fCentro'), centri, state.filter.centro, 'Centri');
    qs('#centriList').innerHTML = [...new Set([...CENTRI_DEF, ...centri])].sort().map(v=>`<option value="${esc(v)}">`).join('');
    qs('#vociList').innerHTML = ruoli.sort().map(v=>`<option value="${esc(v)}">`).join('');
  }

  function fillSelect(el, arr, current, defLabel){ el.innerHTML = `<option value="">${defLabel}</option>` + arr.sort().map(v => `<option value="${esc(v)}" ${v===current?'selected':''}>${esc(v)}</option>`).join(''); }
  function unique(arr){ return [...new Set(arr.filter(x=>x))]; }
  function esc(s){ return (s||'').replace(/"/g, '&quot;'); }
  function fmtNum(n){ return (n||0).toLocaleString('it-IT',{minimumFractionDigits:0, maximumFractionDigits:2}); }

  function sortBy(field){
      const glob = state.coeffGlobale;
      state.rows.sort((a,b) => {
          let va=0, vb=0;
          if(field === 'cd'){ va = a.oreDir*a.costoOrario*(a.coeffDir||1); vb = b.oreDir*b.costoOrario*(b.coeffDir||1); } 
          else if(field === 'ci'){ va = a.oreInd*a.costoInd*(a.coeffInd||1); vb = b.oreInd*b.costoInd*(b.coeffInd||1); }
          return vb - va;
      });
      renderStructure(); updateCalculations();
  }

  function exportCSV(){
      const head = ['Tipo','Centro','Ruolo','Ore Dir','Costo H','Coeff','Tot Dir','Ore Ind','Costo H Ind','Coeff','Tot Ind','Forfait','Note'];
      const rows = state.rows.map(r => [
          r.tipo, r.centro, r.ruolo, fmtDec.format(r.oreDir), fmtDec.format(r.costoOrario), fmtDec.format(r.coeffDir), fmtDec.format(r.oreDir*r.costoOrario*r.coeffDir),
          fmtDec.format(r.oreInd), fmtDec.format(r.costoInd), fmtDec.format(r.coeffInd), fmtDec.format(r.oreInd*r.costoInd*r.coeffInd), fmtDec.format(r.forfait), r.note
      ].join(';'));
      const extra = `\n\nPARAMETRI GENERALI\nOverhead %;${state.overheadPct}\nCoeff. Str;${state.coeffGlobale}\nImprevisti %;${state.imprevistiPct}\nMargine %;${state.marginePct}\nCosti Fissi;${state.costiFissi}`;
      const csv = '\uFEFF' + head.join(';') + '\n' + rows.join('\n') + extra;
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='AnalisiCosti_v2.csv'; document.body.appendChild(a); a.click(); a.remove();
  }
  function downloadJSON(obj, name){ const blob = new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
  function loadJSON(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange=e=>{ const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>{ try{Object.assign(state,JSON.parse(ev.target.result)); renderStructure(); updateCalculations();}catch(x){alert('Errore file');} }; r.readAsText(f); } }; inp.click(); }

  return { init, addRow: qs('#addRow').onclick, sortBy, filterC };
})();

app.init();
</script>
</body>
</html>
