<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STANDARD v2.3 â€” Ore & Costi + Dashboard</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0f1115; --panel:#151821; --muted:#1b2030; --text:#e6e6e6; --sub:#aeb6c2; --accent:#5eead4;
      --line:#2a3042; --danger:#f43f5e; --success:#10b981; --warning:#f59e0b;
      --chart-1:#6366f1; --chart-2:#ec4899; --chart-3:#10b981; --chart-4:#f59e0b;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:13px/1.4 'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:12px;display:flex;flex-direction:column;min-height:100vh;box-sizing:border-box}
    
    /* Toolbar */
    .toolbar{flex:0 0 auto; margin-bottom:12px; z-index:50;}
    .toolbar .inner{display:flex;gap:6px;align-items:center;flex-wrap:wrap;background:var(--panel);padding:8px;border:1px solid var(--line);border-radius:12px}
    
    /* Buttons */
    .btn{background:var(--muted);border:1px solid var(--line);color:var(--text);padding:6px 12px;border-radius:8px;cursor:pointer;display:inline-flex;gap:6px;align-items:center;font-size:12px;font-weight:500;transition:all 0.2s}
    .btn:hover{background:#262d40;border-color:#4b5563}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent); color:#0b0f15; border-color:transparent;font-weight:700}
    .btn.danger{color:var(--danger);border-color:rgba(244,63,94,0.3)}
    .btn.danger:hover{background:rgba(244,63,94,0.1)}

    /* Cards */
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px;flex:0 0 auto}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px;display:flex;flex-direction:column;justify-content:center}
    .card h3{margin:0 0 4px 0;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--sub);font-weight:600}
    .card .big{font-size:18px;font-weight:700;color:var(--text)}
    .card .big.accent{color:var(--accent)}
    .card .big.warning{color:var(--warning)}

    /* Inputs */
    input, select{background:#0b0d12;color:var(--text);border:1px solid #2a3554;border-radius:6px;padding:6px;width:100%;box-sizing:border-box;font-family:inherit;font-size:12px}
    input:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(94,234,212,0.1)}
    .num{text-align:right}
    
    /* Filters */
    .filters{display:flex;gap:6px;align-items:center;flex:1}
    .filters input{min-width:150px}

    /* Grid Table Container */
    .grid-container{flex:1;overflow:hidden;border:1px solid var(--line);border-radius:12px;display:flex;flex-direction:column;background:var(--panel);min-height:300px}
    .grid-scroll{overflow:auto;flex:1}
    
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1200px}
    
    /* Sticky Headers */
    thead th{
      position:sticky; top:0; z-index:10;
      background:#1a1e29;
      border-bottom:1px solid var(--line);
      padding:8px;
      color:var(--sub);
      font-size:11px;
      text-align:left;
      font-weight:600;
      cursor:default;
      user-select:none;
    }
    thead th.sortable:hover{color:var(--accent);cursor:pointer}
    
    tbody tr:hover{background:rgba(255,255,255,0.02)}
    tbody td{border-bottom:1px solid var(--line);padding:4px 6px;vertical-align:middle}
    
    /* Data Bars (Heatmap) */
    .data-bar-cell{position:relative;z-index:1}
    .data-bar{position:absolute;top:2px;bottom:2px;right:2px;background:rgba(94,234,212,0.15);z-index:-1;border-radius:4px;transition:width 0.3s}
    
    /* Sticky Footer inside table */
    tfoot td{
      position:sticky; bottom:0; z-index:10;
      background:#1a1e29;
      border-top:1px solid var(--line);
      padding:8px;
      font-weight:600;
      color:var(--accent);
    }

    /* Section Split */
    .split{display:grid;grid-template-columns:3fr 1fr;gap:8px;margin-bottom:8px;flex:0 0 auto}
    .param-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px 12px}
    .param-grid label{font-size:11px;color:var(--sub);display:block;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    
    /* --- NEW DASHBOARD STYLES --- */
    .dashboard{margin-top:12px; display:grid; grid-template-columns:1fr 1fr 300px; gap:12px; height:220px; flex:0 0 auto}
    .dash-panel{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px; display:flex; flex-direction:column; position:relative}
    .dash-title{font-size:12px; font-weight:600; color:var(--sub); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px}
    
    /* SVG Charts */
    .chart-container{flex:1; display:flex; align-items:center; justify-content:center; width:100%; overflow:hidden}
    .legend{font-size:11px; margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .dot{width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px}
    
    /* Bar Chart Rows */
    .bar-row{display:flex; align-items:center; gap:8px; margin-bottom:4px; font-size:11px; width:100%}
    .bar-label{width:80px; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bar-track{flex:1; background:#1f2430; height:16px; border-radius:4px; overflow:hidden}
    .bar-fill{height:100%; background:var(--accent); transition:width 0.5s ease-out}
    .bar-val{width:50px; text-align:right; font-weight:600}

    /* Top List */
    .top-item{display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid var(--line); font-size:11px}
    .top-item:last-child{border:none}
    
    /* Utilities */
    .badge{font-size:10px;color:#0b0f15;background:var(--accent);padding:1px 6px;border-radius:99px;font-weight:700;margin-left:8px;vertical-align:middle}
    .note{color:var(--sub);font-size:11px}
    .text-right{text-align:right}

    /* Print */
    @media print{
      @page{size:A4 landscape;margin:5mm}
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact}
      .toolbar, .filters, .note-download{display:none !important}
      .wrap{height:auto;overflow:visible;display:block}
      .grid-container{border:none;overflow:visible; min-height:auto}
      table{border:1px solid #ccc; font-size:10px}
      thead th{background:#eee;color:#000;border-bottom:1px solid #000}
      tbody td{border-bottom:1px solid #ccc}
      input{border:none;background:transparent;color:#000;padding:0}
      .card, .dash-panel{border:1px solid #000;break-inside:avoid;page-break-inside:avoid}
      .data-bar{display:none} 
      .dashboard{height:auto; grid-template-columns:1fr 1fr; margin-top:20px}
      .chart-container svg text{fill:#000 !important}
    }
  </style>
</head>
<body>

<div class="wrap">
  
  <!-- Header & Toolbar -->
  <div>
    <h2 style="margin:0 0 8px 0;display:flex;align-items:center">
      Standard v2.3 <span style="font-weight:400;color:var(--sub);margin:0 8px">â€” Ore & Costi + Dashboard</span>
      <span class="badge">ANALYTICS</span>
    </h2>
    
    <div class="toolbar">
      <div class="inner">
        <button class="btn primary" id="addRow"><span>+</span> Riga</button>
        <button class="btn" id="dupRow">Duplica</button>
        <button class="btn danger" id="delRow">Elimina</button>
        <span style="width:1px;height:20px;background:var(--line);margin:0 4px"></span>
        <button class="btn" id="restoreDefaults">Ripristina Standard</button>
        <button class="btn" id="reset">Nuovo</button>
        
        <div class="filters" style="margin-left:12px">
          <input id="search" placeholder="ðŸ” Cerca ruolo, note..." />
          <select id="fTipo" style="width:auto"><option value="">Tutti i Tipi</option><option>Interno</option><option>Esterno</option></select>
          <select id="fCentro" style="width:auto"><option value="">Tutti i Centri</option></select>
        </div>

        <button class="btn" id="exportCSV">CSV</button>
        <button class="btn" id="print">PDF</button>
        <button class="btn" id="save">Salva</button>
        <button class="btn" id="load">Carica</button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <section class="cards" id="summaryCards">
    <div class="card">
        <h3>Costo Diretto</h3>
        <div class="big" id="costoDirettoTot">â‚¬ 0</div>
        <div class="note" id="oreDiretteTot">0 h</div>
    </div>
    <div class="card">
        <h3>Costo Industriale</h3>
        <div class="big" id="costoIndustriale">â‚¬ 0</div>
        <div class="note">Dir + Ind + Forf + Overhead</div>
    </div>
    <div class="card">
        <h3>Costo Pieno</h3>
        <div class="big warning" id="costoPieno">â‚¬ 0</div>
        <div class="note">+ Imprevisti + Fissi</div>
    </div>
    <div class="card" style="border-color:var(--accent)">
        <h3>PREZZO TOTALE</h3>
        <div class="big accent" id="prezzoFinale">â‚¬ 0</div>
        <div class="note">+ Margine %</div>
    </div>
  </section>

  <!-- Parameters -->
  <section class="split">
    <div class="card">
      <h3>Parametri Economici Generali</h3>
      <div class="param-grid">
        <div><label title="Percentuale calcolata sui costi diretti">Overhead % (su Dir.)</label><input type="text" class="num" id="overheadPct" value="15,00"></div>
        <div><label title="Moltiplicatore globale del costo orario">Coeff. Straordinari</label><input type="text" class="num" id="coeffGlobale" value="1,00"></div>
        <div><label title="Percentuale di sicurezza sul costo totale">Imprevisti % (Rischio)</label><input type="text" class="num" id="imprevistiPct" value="0,00"></div>
        <div><label title="Percentuale di ricarico sul costo pieno">Margine % (Utile)</label><input type="text" class="num" id="marginePct" value="10,00"></div>
        
        <div><label title="Costi fissi extra commessa">Costi Fissi Extra (â‚¬)</label><input type="text" class="num" id="costiFissi" value="0"></div>
        <div><label>Totale Pezzi (opz.)</label><input type="text" class="num" id="pezzi" placeholder="0"></div>
        <div><label>Totale mÂ³ (opz.)</label><input type="text" class="num" id="volume" placeholder="0,00"></div>
        <div></div> 
      </div>
    </div>
    <div class="card">
      <h3>Indicatori Unitari</h3>
      <div style="display:flex;flex-direction:column;justify-content:center;height:100%;gap:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding-bottom:4px">
            <span class="note">Prezzo / Pezzo</span>
            <span class="big" style="font-size:16px" id="costoPerPezzo">â‚¬ 0,00</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="note">Prezzo / mÂ³</span>
            <span class="big" style="font-size:16px" id="costoPerMc">â‚¬ 0,00</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Grid -->
  <div class="grid-container">
    <div class="grid-scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:30px"><input type="checkbox" id="selAll"></th>
            <th style="width:90px">Tipo</th>
            <th style="width:130px">Centro Costo</th>
            <th style="min-width:180px">Ruolo / Voce</th>
            <th class="num" style="width:60px">Ore D.</th>
            <th class="num" style="width:70px">â‚¬/h</th>
            <th class="num" style="width:50px">Coeff</th>
            <th class="num sortable" onclick="app.sortBy('cd')" style="width:90px">Costo Dir. â–¼</th>
            <th class="num" style="width:60px">Ore I.</th>
            <th class="num" style="width:70px">â‚¬/h Ind.</th>
            <th class="num" style="width:50px">Coeff</th>
            <th class="num sortable" onclick="app.sortBy('ci')" style="width:90px">Costo Ind. â–¼</th>
            <th class="num" style="width:80px">Forfait</th>
            <th style="min-width:150px">Note</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
        <tfoot>
          <tr>
            <td colspan="4">Totali Pagina</td>
            <td class="num" id="ftOreD">0</td>
            <td></td><td></td>
            <td class="num" id="ftCostD">â‚¬ 0</td>
            <td class="num" id="ftOreI">0</td>
            <td></td><td></td>
            <td class="num" id="ftCostI">â‚¬ 0</td>
            <td class="num" id="ftForfait">â‚¬ 0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- DASHBOARD ANALITICA -->
  <section class="dashboard">
    <!-- Grafico 1: Composizione Prezzo -->
    <div class="dash-panel">
        <div class="dash-title">Composizione Prezzo Finale</div>
        <div class="chart-container" id="chartDonut">
            <!-- SVG injected here -->
        </div>
        <div class="legend">
            <div><span class="dot" style="background:var(--chart-1)"></span>Diretti</div>
            <div><span class="dot" style="background:var(--chart-2)"></span>Indiretti</div>
            <div><span class="dot" style="background:var(--chart-3)"></span>Spese Gen.</div>
            <div><span class="dot" style="background:var(--chart-4)"></span>Margine</div>
        </div>
    </div>

    <!-- Grafico 2: Costi per Centro -->
    <div class="dash-panel">
        <div class="dash-title">Incidenza Centri di Costo</div>
        <div class="chart-container" style="display:block; overflow-y:auto" id="chartBars">
            <!-- Bars injected here -->
        </div>
    </div>

    <!-- Statistiche -->
    <div class="dash-panel">
        <div class="dash-title">Top 3 Voci di Spesa</div>
        <div id="topList" style="flex:1; margin-bottom:12px"></div>
        
        <div class="dash-title" style="margin-top:auto;border-top:1px solid var(--line);padding-top:8px">Efficienza</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="note">Rapporto Ore Ind/Dir</span>
            <span class="big" id="ratioEff">0%</span>
        </div>
    </div>
  </section>

  <datalist id="centriList"></datalist>
  <datalist id="vociList"></datalist>
</div>

<script>
const app = (function(){
  const fmtEur = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR', maximumFractionDigits:0});
  const fmtDec = new Intl.NumberFormat('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2});
  const parseNum = v => {
    if(!v) return 0;
    if(typeof v==='number') return v;
    const n = parseFloat((''+v).replace(/\./g,'').replace(',','.'));
    return isNaN(n)?0:n;
  };
  const qs = s => document.querySelector(s);
  const qsa = s => document.querySelectorAll(s);

  const CENTRI_DEF = ['Reparto','Ferro','Magazzino','Ufficio Tecnico','QualitÃ ','Manutenzione','Logistica','Sicurezza','Servizi','Amministrazione','Commerciale'];
  
  const DEFAULT_ROWS = [
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Capo reparto', oreDir:0, costoOrario:28, coeffDir:1, oreInd:6, costoInd:28, coeffInd:1, forfait:0, note:'coordinamento'},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Carpentieri casseri', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Operaio getto', oreDir:0, costoOrario:22, coeffDir:1, oreInd:0, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Finitura / vibrazione', oreDir:0, costoOrario:21, coeffDir:1, oreInd:0, costoInd:21, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Reparto',ruolo:'Pulizia casseri', oreDir:0, costoOrario:20, coeffDir:1, oreInd:0, costoInd:20, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ferro',ruolo:'Armatori (gabbie)', oreDir:0, costoOrario:25, coeffDir:1, oreInd:0, costoInd:25, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ferro',ruolo:'Taglio e piega', oreDir:0, costoOrario:24, coeffDir:1, oreInd:0, costoInd:24, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Magazzino',ruolo:'Carrellisti', oreDir:0, costoOrario:20, coeffDir:1, oreInd:0, costoInd:20, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Logistica',ruolo:'Pianificazione carichi', oreDir:0, costoOrario:21, coeffDir:1, oreInd:2, costoInd:21, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Manutenzione',ruolo:'Meccanici/impiantisti', oreDir:0, costoOrario:23, coeffDir:1, oreInd:2, costoInd:23, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'QualitÃ ',ruolo:'Collaudi e controlli', oreDir:0, costoOrario:24, coeffDir:1, oreInd:3, costoInd:24, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Sicurezza',ruolo:'Preposto / RSPP', oreDir:0, costoOrario:22, coeffDir:1, oreInd:2, costoInd:22, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'Disegnatori', oreDir:0, costoOrario:28, coeffDir:1, oreInd:6, costoInd:28, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Ufficio Tecnico',ruolo:'Tecnico di produzione', oreDir:0, costoOrario:29, coeffDir:1, oreInd:4, costoInd:29, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Amministrazione',ruolo:'Segreteria', oreDir:0, costoOrario:26, coeffDir:1, oreInd:3, costoInd:26, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Interno',centro:'Commerciale',ruolo:'Preventivista / PM', oreDir:0, costoOrario:27, coeffDir:1, oreInd:2, costoInd:27, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Nolo autogru', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'tariffa/giorno'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Trasporto (Bilico)', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/viaggio'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Trasporto (Carro attrez.)', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/viaggio'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Piattaforma aerea', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/giorno'},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Subappalto casseri', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:''},
    {sel:false,tipo:'Esterno',centro:'Servizi',ruolo:'Stoccaggio esterno', oreDir:0, costoOrario:0, coeffDir:1, oreInd:0, costoInd:0, coeffInd:1, forfait:0, note:'â‚¬/mese'}
  ];

  let state = {
    rows: JSON.parse(JSON.stringify(DEFAULT_ROWS)),
    overheadPct: 15,
    imprevistiPct: 0,
    marginePct: 10,
    costiFissi: 0,
    pezzi: 0,
    volume: 0,
    coeffGlobale: 1,
    filter: { q:'', tipo:'', centro:'' }
  };

  function init(){
    loadLS();
    bindEvents();
    renderStructure(); 
    updateCalculations();
  }

  function saveLS(){ localStorage.setItem('OreCosti_v2', JSON.stringify(state)); }
  function loadLS(){ const d = localStorage.getItem('OreCosti_v2'); if(d) { try{ Object.assign(state, JSON.parse(d)); }catch(e){} } }

  function renderStructure(){
    const tbody = qs('#body');
    const filtered = getFilteredRows();
    if(filtered.length === 0){
      tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:20px;color:var(--sub)">Nessuna voce trovata. <button class="btn" onclick="app.addRow()">Aggiungi riga</button></td></tr>';
      updateFiltersUI();
      return;
    }
    const html = filtered.map(({r, idx}) => {
      const isExt = r.tipo==='Esterno';
      let bgStyle = isExt ? 'background:rgba(94,234,212,0.03)' : '';
      return `<tr data-idx="${idx}" style="${bgStyle}">
        <td style="text-align:center"><input type="checkbox" class="row-sel" ${r.sel?'checked':''}></td>
        <td><select class="inp-tipo"><option ${r.tipo==='Interno'?'selected':''}>Interno</option><option ${r.tipo==='Esterno'?'selected':''}>Esterno</option></select></td>
        <td><input type="text" list="centriList" class="inp-centro" value="${esc(r.centro)}"></td>
        <td><input type="text" list="vociList" class="inp-ruolo" value="${esc(r.ruolo)}"></td>
        <td><input type="text" class="num inp-calc inp-oreD" value="${fmtNum(r.oreDir)}"></td>
        <td><input type="text" class="num inp-calc inp-costoH" value="${fmtNum(r.costoOrario)}"></td>
        <td><input type="text" class="num inp-calc inp-cDir" value="${fmtNum(r.coeffDir)}"></td>
        <td class="num data-bar-cell"><div class="data-bar bar-cd" style="width:0%"></div><span class="val-cd">â‚¬ 0</span></td>
        <td><input type="text" class="num inp-calc inp-oreI" value="${fmtNum(r.oreInd)}"></td>
        <td><input type="text" class="num inp-calc inp-costoHi" value="${fmtNum(r.costoInd)}"></td>
        <td><input type="text" class="num inp-calc inp-cInd" value="${fmtNum(r.coeffInd)}"></td>
        <td class="num data-bar-cell"><div class="data-bar bar-ci" style="width:0%"></div><span class="val-ci">â‚¬ 0</span></td>
        <td><input type="text" class="num inp-calc inp-forf" value="${fmtNum(r.forfait)}"></td>
        <td><input type="text" class="inp-note" value="${esc(r.note)}"></td>
      </tr>`;
    }).join('');
    tbody.innerHTML = html;
    updateFiltersUI();
  }

  function updateCalculations(){
    state.overheadPct = parseNum(qs('#overheadPct').value);
    state.imprevistiPct = parseNum(qs('#imprevistiPct').value);
    state.marginePct = parseNum(qs('#marginePct').value);
    state.costiFissi = parseNum(qs('#costiFissi').value);
    state.coeffGlobale = parseNum(qs('#coeffGlobale').value) || 1;
    state.pezzi = parseNum(qs('#pezzi').value);
    state.volume = parseNum(qs('#volume').value);

    let totOreD=0, totOreI=0, totCostD=0, totCostI=0, totForf=0;
    let maxCostRow = 1;
    let centriStats = {};
    let rowCosts = []; // Per Top List

    const rows = Array.from(qs('#body').rows);
    
    rows.forEach(tr => {
      if(!tr.dataset.idx) return;
      const i = +tr.dataset.idx;
      const r = state.rows[i];
      const glob = state.coeffGlobale;

      const cd = r.oreDir * r.costoOrario * (r.coeffDir||1) * glob;
      const ci = r.oreInd * r.costoInd * (r.coeffInd||1) * glob;
      const rf = (r.tipo==='Esterno') ? r.forfait : 0;
      const totRow = cd + ci + rf;

      // Stats accumulation
      if(r.centro){
        centriStats[r.centro] = (centriStats[r.centro] || 0) + totRow;
      }
      rowCosts.push({role: r.ruolo, val: totRow});

      tr.querySelector('.val-cd').textContent = fmtEur.format(cd);
      tr.querySelector('.val-ci').textContent = fmtEur.format(ci);
      
      totOreD += r.oreDir;
      totOreI += r.oreInd;
      totCostD += cd;
      totCostI += ci;
      totForf += rf;
      
      maxCostRow = Math.max(maxCostRow, cd, ci);
    });

    rows.forEach(tr => {
        if(!tr.dataset.idx) return;
        const i = +tr.dataset.idx;
        const r = state.rows[i];
        const glob = state.coeffGlobale;
        const cd = r.oreDir * r.costoOrario * (r.coeffDir||1) * glob;
        const ci = r.oreInd * r.costoInd * (r.coeffInd||1) * glob;
        tr.querySelector('.bar-cd').style.width = (cd/maxCostRow*100)+'%';
        tr.querySelector('.bar-ci').style.width = (ci/maxCostRow*100)+'%';
    });

    // Totali
    const overheadVal = totCostD * (state.overheadPct/100);
    const costoIndustriale = totCostD + totCostI + totForf + overheadVal;
    const imprevistiVal = costoIndustriale * (state.imprevistiPct/100);
    const speseGenFisse = state.costiFissi; // Solo la parte Fissa
    const costoPieno = costoIndustriale + imprevistiVal + speseGenFisse;
    const margineVal = costoPieno * (state.marginePct/100);
    const prezzoFinale = costoPieno + margineVal;

    qs('#oreDiretteTot').textContent = fmtDec.format(totOreD) + ' h';
    qs('#costoDirettoTot').textContent = fmtEur.format(totCostD);
    qs('#costoIndustriale').textContent = fmtEur.format(costoIndustriale);
    qs('#costoPieno').textContent = fmtEur.format(costoPieno);
    qs('#prezzoFinale').textContent = fmtEur.format(prezzoFinale);

    const pp = state.pezzi > 0 ? prezzoFinale/state.pezzi : 0;
    const pm = state.volume > 0 ? prezzoFinale/state.volume : 0;
    qs('#costoPerPezzo').textContent = fmtEur.format(pp);
    qs('#costoPerMc').textContent = fmtEur.format(pm);

    qs('#ftOreD').textContent = fmtDec.format(totOreD);
    qs('#ftCostD').textContent = fmtEur.format(totCostD);
    qs('#ftOreI').textContent = fmtDec.format(totOreI);
    qs('#ftCostI').textContent = fmtEur.format(totCostI);
    qs('#ftForfait').textContent = fmtEur.format(totForf);

    // --- DASHBOARD UPDATES ---
    
    // 1. Donut Chart Data
    // Segments: Direct, Indirect+Forfait, Expenses(Overhead+Impr+Fissi), Margin
    const v1 = totCostD;
    const v2 = totCostI + totForf;
    const v3 = overheadVal + imprevistiVal + speseGenFisse;
    const v4 = margineVal;
    drawDonut([v1, v2, v3, v4], prezzoFinale);

    // 2. Bar Chart Data (Centri)
    drawBars(centriStats, costoIndustriale); // use Costo Ind as base for percentage visuals

    // 3. Stats
    // Top 3
    rowCosts.sort((a,b) => b.val - a.val);
    const top3 = rowCosts.slice(0,3);
    qs('#topList').innerHTML = top3.map(i => 
        `<div class="top-item"><span>${esc(i.role || 'N.D.')}</span><b>${fmtEur.format(i.val)}</b></div>`
    ).join('') || '<div class="note" style="text-align:center">Nessun dato</div>';

    // Efficiency Ratio
    const ratio = totOreD > 0 ? (totOreI / totOreD) * 100 : 0;
    qs('#ratioEff').textContent = ratio.toFixed(1) + '%';
    qs('#ratioEff').style.color = ratio > 30 ? 'var(--warning)' : 'var(--success)';
  }

  // --- CHARTING ENGINE (No Libraries) ---
  function drawDonut(values, total){
     const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b']; // matches CSS vars
     if(total <= 0) { qs('#chartDonut').innerHTML = '<div class="note">Nessun dato</div>'; return; }
     
     let acc = 0;
     const r = 15.9155; // radius for circumference 100
     const c = 100;
     
     const svgContent = values.map((v, i) => {
         const pct = (v / total) * 100;
         const dash = `${Math.max(0, pct - 0.5)} ${100 - Math.max(0, pct - 0.5)}`; // small gap
         const segment = `<circle cx="21" cy="21" r="${r}" fill="transparent" stroke="${colors[i]}" stroke-width="6" stroke-dasharray="${dash}" stroke-dashoffset="${25 - acc}"></circle>`;
         acc += pct;
         return segment;
     }).join('');

     // Center Text
     const centerText = `<text x="21" y="21" fill="var(--text)" font-size="6" font-weight="bold" text-anchor="middle" dy="2.5">100%</text>`;

     qs('#chartDonut').innerHTML = `<svg width="100%" height="100%" viewBox="0 0 42 42">${svgContent}${centerText}</svg>`;
  }

  function drawBars(dataMap, maxBase){
      const container = qs('#chartBars');
      const entries = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]);
      if(entries.length === 0) { container.innerHTML = '<div class="note">Nessun dato</div>'; return; }
      
      const maxVal = entries[0][1] || 1;
      
      container.innerHTML = entries.map(([label, val]) => {
          const pct = (val / maxVal) * 100;
          return `<div class="bar-row">
            <div class="bar-label" title="${esc(label)}">${esc(label)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div class="bar-val">${fmtEur.format(val)}</div>
          </div>`;
      }).join('');
  }

  function bindEvents(){
    qsa('.split input').forEach(el => el.addEventListener('input', ()=>{ updateCalculations(); saveLS(); }));
    const body = qs('#body');
    body.addEventListener('input', e => {
      const el = e.target;
      const tr = el.closest('tr');
      if(!tr) return;
      const i = +tr.dataset.idx;
      const r = state.rows[i];
      if(el.classList.contains('inp-calc')) {
        if(el.classList.contains('inp-oreD')) r.oreDir = parseNum(el.value);
        if(el.classList.contains('inp-costoH')) r.costoOrario = parseNum(el.value);
        if(el.classList.contains('inp-cDir')) r.coeffDir = parseNum(el.value);
        if(el.classList.contains('inp-oreI')) r.oreInd = parseNum(el.value);
        if(el.classList.contains('inp-costoHi')) r.costoInd = parseNum(el.value);
        if(el.classList.contains('inp-cInd')) r.coeffInd = parseNum(el.value);
        if(el.classList.contains('inp-forf')) r.forfait = parseNum(el.value);
        updateCalculations(); 
      } else if(el.classList.contains('inp-tipo')){ r.tipo = el.value; renderStructure(); 
      } else if(el.classList.contains('inp-centro')){ r.centro = el.value; updateFiltersUI(); 
      } else if(el.classList.contains('inp-ruolo')){ r.ruolo = el.value;
      } else if(el.classList.contains('inp-note')){ r.note = el.value;
      } else if(el.classList.contains('row-sel')){ r.sel = el.checked; }
      saveLS();
    });
    qs('#addRow').onclick = () => { state.rows.push({sel:false,tipo:'Interno',centro:'',ruolo:'',oreDir:0,costoOrario:0,coeffDir:1,oreInd:0,costoInd:0,coeffInd:1,forfait:0,note:''}); renderStructure(); updateCalculations(); saveLS(); };
    qs('#dupRow').onclick = () => { const dups = state.rows.filter(r=>r.sel).map(r=>({...r, sel:false})); if(dups.length){ state.rows.push(...dups); renderStructure(); updateCalculations(); saveLS(); } };
    qs('#delRow').onclick = () => { if(!confirm('Eliminare righe?')) return; state.rows = state.rows.filter(r=>!r.sel); renderStructure(); updateCalculations(); saveLS(); };
    qs('#restoreDefaults').onclick = () => { DEFAULT_ROWS.forEach(def => { if(!state.rows.find(r => r.centro===def.centro && r.ruolo===def.ruolo)){ state.rows.push(JSON.parse(JSON.stringify(def))); } }); renderStructure(); updateCalculations(); saveLS(); };
    qs('#reset').onclick = () => { if(confirm('Cancellare tutto?')){ state.rows = []; renderStructure(); updateCalculations(); saveLS(); } };
    qs('#selAll').onchange = (e) => { state.rows.forEach(r => r.sel = e.target.checked); renderStructure(); };
    ['search','fTipo','fCentro'].forEach(id => { qs('#'+id).addEventListener('input', e => { state.filter.q = qs('#search').value.toLowerCase(); state.filter.tipo = qs('#fTipo').value; state.filter.centro = qs('#fCentro').value; renderStructure(); updateCalculations(); }); });
    qs('#print').onclick = () => window.print();
    qs('#exportCSV').onclick = exportCSV;
    qs('#save').onclick = () => downloadJSON(state, 'OreCosti.json');
    qs('#load').onclick = loadJSON;
  }

  function getFilteredRows(){
    const f = state.filter;
    return state.rows.map((r,idx)=>({r,idx})).filter(({r}) => {
        if(f.tipo && r.tipo !== f.tipo) return false;
        if(f.centro && r.centro !== f.centro) return false;
        if(f.q && !((r.ruolo||'').toLowerCase().includes(f.q) || (r.note||'').toLowerCase().includes(f.q))) return false;
        return true;
    });
  }

  function updateFiltersUI(){
    const centri = unique(state.rows.map(r=>r.centro));
    const ruoli = unique(state.rows.map(r=>r.ruolo));
    fillSelect(qs('#fCentro'), centri, state.filter.centro, 'Tutti i Centri');
    qs('#centriList').innerHTML = [...new Set([...CENTRI_DEF, ...centri])].sort().map(v=>`<option value="${esc(v)}">`).join('');
    qs('#vociList').innerHTML = ruoli.sort().map(v=>`<option value="${esc(v)}">`).join('');
  }

  function fillSelect(el, arr, current, defLabel){ el.innerHTML = `<option value="">${defLabel}</option>` + arr.sort().map(v => `<option value="${esc(v)}" ${v===current?'selected':''}>${esc(v)}</option>`).join(''); }
  function unique(arr){ return [...new Set(arr.filter(x=>x))]; }
  function esc(s){ return (s||'').replace(/"/g, '&quot;'); }
  function fmtNum(n){ return (n||0).toLocaleString('it-IT',{minimumFractionDigits:0, maximumFractionDigits:2}); }

  function sortBy(field){
      const glob = state.coeffGlobale;
      state.rows.sort((a,b) => {
          let va=0, vb=0;
          if(field === 'cd'){ va = a.oreDir*a.costoOrario*(a.coeffDir||1); vb = b.oreDir*b.costoOrario*(b.coeffDir||1); } 
          else if(field === 'ci'){ va = a.oreInd*a.costoInd*(a.coeffInd||1); vb = b.oreInd*b.costoInd*(b.coeffInd||1); }
          return vb - va;
      });
      renderStructure(); updateCalculations();
  }

  function exportCSV(){
      const head = ['Tipo','Centro','Ruolo','Ore Dir','Costo H','Coeff','Tot Dir','Ore Ind','Costo H Ind','Coeff','Tot Ind','Forfait','Note'];
      const rows = state.rows.map(r => [
          r.tipo, r.centro, r.ruolo, fmtDec.format(r.oreDir), fmtDec.format(r.costoOrario), fmtDec.format(r.coeffDir), fmtDec.format(r.oreDir*r.costoOrario*r.coeffDir),
          fmtDec.format(r.oreInd), fmtDec.format(r.costoInd), fmtDec.format(r.coeffInd), fmtDec.format(r.oreInd*r.costoInd*r.coeffInd), fmtDec.format(r.forfait), r.note
      ].join(';'));
      const extra = `\n\nPARAMETRI GENERALI\nOverhead %;${state.overheadPct}\nCoeff. Str;${state.coeffGlobale}\nImprevisti %;${state.imprevistiPct}\nMargine %;${state.marginePct}\nCosti Fissi;${state.costiFissi}`;
      const csv = '\uFEFF' + head.join(';') + '\n' + rows.join('\n') + extra;
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='OreCosti_v2.csv'; document.body.appendChild(a); a.click(); a.remove();
  }
  function downloadJSON(obj, name){ const blob = new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
  function loadJSON(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange=e=>{ const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>{ try{Object.assign(state,JSON.parse(ev.target.result)); renderStructure(); updateCalculations();}catch(x){alert('Errore file');} }; r.readAsText(f); } }; inp.click(); }

  return { init, addRow: qs('#addRow').onclick, sortBy };
})();

app.init();
</script>
</body>
</html>
